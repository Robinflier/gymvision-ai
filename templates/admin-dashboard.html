<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin Dashboard - GymVision AI</title>
	<link rel="stylesheet" href="/static/styles.css">
	<!-- Supabase library - MUST load before script -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<style>
		body {
			background: #0f0f10;
			color: #fff;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
			margin: 0;
			padding: 0;
		}
		.login-container {
			display: none !important; /* TEMPORARILY HIDE LOGIN */
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			padding: 20px;
		}
		.login-card {
			background: #1a1a1b;
			border: 1px solid #2a2a2b;
			border-radius: 12px;
			padding: 40px;
			width: 100%;
			max-width: 400px;
		}
		.login-card h1 {
			margin: 0 0 10px 0;
			color: #fff;
			font-size: 24px;
		}
		.login-card p {
			color: #888;
			margin-bottom: 30px;
		}
		.login-form-group {
			margin-bottom: 20px;
		}
		.login-form-group label {
			display: block;
			margin-bottom: 8px;
			color: #fff;
			font-weight: 600;
		}
		.login-form-group input {
			width: 100%;
			padding: 12px;
			background: #252528;
			border: 1px solid #333;
			border-radius: 8px;
			color: #fff;
			font-size: 16px;
			box-sizing: border-box;
		}
		.login-form-group input:focus {
			outline: none;
			border-color: #667eea;
		}
		.login-btn {
			width: 100%;
			padding: 12px;
			background: #667eea;
			color: white;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			margin-top: 10px;
		}
		.login-btn:hover {
			background: #5568d3;
		}
		.login-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.login-error {
			background: #fee;
			color: #c33;
			padding: 15px;
			border-radius: 6px;
			margin-bottom: 20px;
			display: none;
		}
		.login-error.show {
			display: block;
		}
		.admin-container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			display: none;
		}
		.admin-container.authenticated {
			display: block;
		}
		.admin-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 30px;
			border-radius: 12px;
			margin-bottom: 30px;
		}
		.admin-header h1 {
			margin: 0 0 10px 0;
			font-size: 28px;
		}
		.admin-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		.admin-stat-card {
			background: #1a1a1b;
			padding: 20px;
			border-radius: 8px;
			border: 1px solid #2a2a2b;
		}
		.admin-stat-card h3 {
			margin: 0 0 10px 0;
			color: #667eea;
			font-size: 14px;
			text-transform: uppercase;
		}
		.admin-stat-card .stat-value {
			font-size: 32px;
			font-weight: bold;
			color: #fff;
		}
		.gym-accounts-list {
			background: #1a1a1b;
			border-radius: 8px;
			border: 1px solid #2a2a2b;
			overflow: hidden;
		}
		.gym-account-item {
			padding: 20px;
			border-bottom: 1px solid #2a2a2b;
			display: grid;
			grid-template-columns: 1fr auto auto auto;
			gap: 20px;
			align-items: center;
		}
		.gym-account-item:last-child {
			border-bottom: none;
		}
		.gym-account-info h3 {
			margin: 0 0 5px 0;
			color: #fff;
		}
		.gym-account-info p {
			margin: 5px 0;
			color: #888;
			font-size: 14px;
		}
		.gym-account-status {
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		.status-badge {
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			text-align: center;
		}
		.status-badge.verified {
			background: #10b981;
			color: white;
		}
		.status-badge.unverified {
			background: #f59e0b;
			color: white;
		}
		.status-badge.premium {
			background: #8b5cf6;
			color: white;
		}
		.status-badge.basic {
			background: #6b7280;
			color: white;
		}
		.admin-actions {
			display: flex;
			gap: 10px;
		}
		.btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 600;
			transition: all 0.2s;
		}
		.btn-primary {
			background: #667eea;
			color: white;
		}
		.btn-primary:hover {
			background: #5568d3;
		}
		.btn-success {
			background: #10b981;
			color: white;
		}
		.btn-success:hover {
			background: #059669;
		}
		.btn-danger {
			background: #ef4444;
			color: white;
		}
		.btn-danger:hover {
			background: #dc2626;
		}
		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		.loading {
			text-align: center;
			padding: 40px;
			color: #888;
		}
		.error {
			background: #fee;
			color: #c33;
			padding: 15px;
			border-radius: 6px;
			margin-bottom: 20px;
		}
		.filter-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}
		.filter-tab {
			padding: 10px 20px;
			background: #1a1a1b;
			border: 2px solid #2a2a2b;
			border-radius: 6px;
			cursor: pointer;
			font-weight: 600;
			color: #fff;
			transition: all 0.2s;
		}
		.filter-tab.active {
			background: #667eea;
			color: white;
			border-color: #667eea;
		}
		.checkbox-wrapper {
			display: flex;
			align-items: center;
			gap: 8px;
			color: #fff;
		}
		.checkbox-wrapper input[type="checkbox"] {
			width: 20px;
			height: 20px;
			cursor: pointer;
		}
	</style>
</head>
<body>
	<!-- LOGIN FORM - TEMPORARILY HIDDEN -->
	<div id="login-container" class="login-container" style="display: none;">
		<div class="login-card">
			<h1>üîê Admin Dashboard</h1>
			<p>Please log in to access the admin panel</p>
			<div id="login-error" class="login-error"></div>
			<form id="login-form" onsubmit="handleLogin(event)">
				<div class="login-form-group">
					<label for="admin-email">Email</label>
					<input type="email" id="admin-email" required autocomplete="new-password" placeholder="Enter your email">
				</div>
				<div class="login-form-group">
					<label for="admin-password">Password</label>
					<input type="password" id="admin-password" required autocomplete="new-password" placeholder="Enter your password">
				</div>
				<button type="submit" class="login-btn" id="login-btn">Sign In</button>
			</form>
		</div>
	</div>

	<!-- ADMIN DASHBOARD - shown if authenticated -->
	<div id="admin-container" class="admin-container">
		<div class="admin-header">
			<h1>üîê Admin Dashboard</h1>
			<p>Manage gym accounts and access permissions</p>
		</div>

		<div id="error-message" class="error" style="display: none;"></div>

		<div class="admin-stats">
			<div class="admin-stat-card">
				<h3>Total Gym Accounts</h3>
				<div class="stat-value" id="stat-total">-</div>
			</div>
			<div class="admin-stat-card">
				<h3>Verified</h3>
				<div class="stat-value" id="stat-verified">-</div>
			</div>
			<div class="admin-stat-card">
				<h3>Unverified</h3>
				<div class="stat-value" id="stat-unverified">-</div>
			</div>
			<div class="admin-stat-card">
				<h3>Premium</h3>
				<div class="stat-value" id="stat-premium">-</div>
			</div>
		</div>

		<div class="filter-tabs">
			<button class="filter-tab active" data-filter="all">All</button>
			<button class="filter-tab" data-filter="unverified">Unverified</button>
			<button class="filter-tab" data-filter="verified">Verified</button>
			<button class="filter-tab" data-filter="premium">Premium</button>
		</div>

		<div class="gym-accounts-list" id="gym-accounts-list">
			<div class="loading">Loading gym accounts...</div>
		</div>
	</div>

	<script>
		const SUPABASE_URL = '{{ SUPABASE_URL }}' || 'https://jugdkqzhcbqbjbvktqlz.supabase.co';
		const SUPABASE_ANON_KEY = '{{ SUPABASE_ANON_KEY }}' || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1Z2RrcXpoY2JxYmpidmt0cWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODI2NzIsImV4cCI6MjA4MDI1ODY3Mn0.rqCqBK14sOZvsxNUhIHIxaOnVMvdnNOjx_0YIXy1VIY';
		
		let supabase;
		let currentFilter = 'all';

		// Initialize Supabase
		async function init() {
			console.log('[ADMIN INIT] TEMPORARILY DISABLED AUTH - showing dashboard directly');
			
			// TEMPORARILY DISABLED AUTH - show dashboard directly, NO LOGIN CHECK
			document.getElementById('login-container').style.display = 'none';
			document.getElementById('admin-container').style.display = 'block';
			document.getElementById('admin-container').classList.add('authenticated');
			
			// Load gym accounts
			try {
				const response = await fetch('/api/admin/gym-accounts');
				if (response.ok) {
					const data = await response.json();
					renderGymAccounts(data.accounts || []);
					updateStats(data.accounts || []);
				} else {
					const errorText = await response.text();
					showError('Failed to load gym accounts: ' + errorText);
				}
			} catch (error) {
				console.error('[ADMIN] Error loading gym accounts:', error);
				showError('Cannot load gym accounts: ' + error.message);
			}
			
			/* ORIGINAL AUTH CODE - DISABLED
			if (typeof window.supabase === 'undefined' || !window.supabase.createClient) {
				console.error('[ADMIN INIT] Supabase library not loaded');
				showLoginError('Supabase library failed to load. Please refresh.');
				return;
			}
			
			supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
			console.log('[ADMIN INIT] Supabase client created:', !!supabase);
			
			// Check if already logged in
			const { data: { session }, error } = await supabase.auth.getSession();
			
			if (error || !session || !session.user) {
				// Not logged in - show login form
				document.getElementById('login-container').style.display = 'flex';
				document.getElementById('admin-container').style.display = 'none';
				return;
			}
			
			// Logged in - verify admin access
			const testResponse = await fetch('/api/admin/gym-accounts', {
				headers: {
					'Authorization': `Bearer ${session.access_token}`
				}
			});
			
			if (testResponse.status === 401 || testResponse.status === 403) {
				// Not admin or session expired
				await supabase.auth.signOut();
				showLoginError('You do not have admin access or your session expired. Please log in again.');
				document.getElementById('login-container').style.display = 'flex';
				document.getElementById('admin-container').style.display = 'none';
				return;
			}
			
			// Authenticated and is admin - show dashboard
			document.getElementById('login-container').style.display = 'none';
			document.getElementById('admin-container').classList.add('authenticated');
			loadGymAccounts();
			*/
		}

		// Handle login form submission
		async function handleLogin(event) {
			event.preventDefault();
			console.log('[ADMIN LOGIN] Form submitted');
			
			const email = document.getElementById('admin-email').value.trim();
			const password = document.getElementById('admin-password').value;
			const loginBtn = document.getElementById('login-btn');
			
			if (!email || !password) {
				showLoginError('Please enter both email and password');
				return;
			}
			
			if (!supabase) {
				console.error('[ADMIN LOGIN] Supabase not initialized');
				showLoginError('Supabase not initialized. Please refresh the page.');
				return;
			}
			
			loginBtn.disabled = true;
			loginBtn.textContent = 'Signing in...';
			hideLoginError();
			
			try {
				console.log('[ADMIN LOGIN] Attempting login for:', email);
				const { data, error } = await supabase.auth.signInWithPassword({
					email: email,
					password: password
				});
				
				if (error) {
					console.error('[ADMIN LOGIN] Login error:', error);
					showLoginError('Login failed: ' + error.message);
					loginBtn.disabled = false;
					loginBtn.textContent = 'Sign In';
					return;
				}
				
				if (!data || !data.user) {
					console.error('[ADMIN LOGIN] No user data returned');
					showLoginError('Login failed: No user data returned');
					loginBtn.disabled = false;
					loginBtn.textContent = 'Sign In';
					return;
				}
				
				console.log('[ADMIN LOGIN] Login successful, checking admin access...');
				// Check admin access
				const testResponse = await fetch('/api/admin/gym-accounts', {
					headers: {
						'Authorization': `Bearer ${data.session.access_token}`
					}
				});
				
				console.log('[ADMIN LOGIN] Admin check response status:', testResponse.status);
				
				if (testResponse.status === 403) {
					await supabase.auth.signOut();
					showLoginError('You do not have admin access. Make sure your email is in ADMIN_USER_EMAILS in Render.');
					loginBtn.disabled = false;
					loginBtn.textContent = 'Sign In';
					return;
				}
				
				if (!testResponse.ok) {
					const errorText = await testResponse.text();
					console.error('[ADMIN LOGIN] Admin check failed:', testResponse.status, errorText);
					showLoginError('Failed to verify admin access. Please try again.');
					loginBtn.disabled = false;
					loginBtn.textContent = 'Sign In';
					return;
				}
				
				console.log('[ADMIN LOGIN] Admin access verified, showing dashboard');
				// Success - show dashboard
				document.getElementById('login-container').style.display = 'none';
				document.getElementById('admin-container').classList.add('authenticated');
				loadGymAccounts();
			} catch (error) {
				console.error('[ADMIN LOGIN] Exception:', error);
				showLoginError('Login error: ' + (error.message || 'Unknown error'));
				loginBtn.disabled = false;
				loginBtn.textContent = 'Sign In';
			}
		}

		function showLoginError(message) {
			const errorEl = document.getElementById('login-error');
			errorEl.textContent = message;
			errorEl.classList.add('show');
		}

		function hideLoginError() {
			document.getElementById('login-error').classList.remove('show');
		}

		async function loadGymAccounts() {
			try {
				const { data: { session }, error: sessionError } = await supabase.auth.getSession();
				
				if (sessionError || !session || !session.user) {
					document.getElementById('login-container').style.display = 'flex';
					document.getElementById('admin-container').style.display = 'none';
					return;
				}

				const response = await fetch('/api/admin/gym-accounts', {
					headers: {
						'Authorization': `Bearer ${session.access_token}`
					}
				});

				if (!response.ok) {
					if (response.status === 401 || response.status === 403) {
						await supabase.auth.signOut();
						document.getElementById('login-container').style.display = 'flex';
						document.getElementById('admin-container').style.display = 'none';
						showLoginError('Session expired or access denied. Please log in again.');
					} else {
						const errorData = await response.json().catch(() => ({}));
						showError('Failed to load gym accounts: ' + (errorData.error || 'Unknown error'));
					}
					return;
				}

				const data = await response.json();
				renderGymAccounts(data.accounts || []);
				updateStats(data.accounts || []);
			} catch (error) {
				console.error('[ADMIN] Error loading gym accounts:', error);
				showError('Failed to load gym accounts: ' + error.message);
			}
		}

		function updateStats(accounts) {
			const total = accounts.length;
			const verified = accounts.filter(a => a.is_verified).length;
			const unverified = total - verified;
			const premium = accounts.filter(a => a.is_premium).length;

			document.getElementById('stat-total').textContent = total;
			document.getElementById('stat-verified').textContent = verified;
			document.getElementById('stat-unverified').textContent = unverified;
			document.getElementById('stat-premium').textContent = premium;
		}

		function renderGymAccounts(accounts) {
			const container = document.getElementById('gym-accounts-list');
			
			if (accounts.length === 0) {
				container.innerHTML = '<div class="loading">No gym accounts found.</div>';
				return;
			}

			// Filter accounts
			let filtered = accounts;
			if (currentFilter === 'unverified') {
				filtered = accounts.filter(a => !a.is_verified);
			} else if (currentFilter === 'verified') {
				filtered = accounts.filter(a => a.is_verified);
			} else if (currentFilter === 'premium') {
				filtered = accounts.filter(a => a.is_premium);
			}

			container.innerHTML = filtered.map(account => `
				<div class="gym-account-item">
					<div class="gym-account-info">
						<h3>${escapeHtml(account.gym_name || 'Unknown')}</h3>
						<p><strong>Email:</strong> ${escapeHtml(account.email || 'N/A')}</p>
						<p><strong>Contact:</strong> ${escapeHtml(account.contact_name || 'N/A')} ${account.contact_phone ? `(${escapeHtml(account.contact_phone)})` : ''}</p>
						<p><strong>Created:</strong> ${formatDate(account.created_at)}</p>
					</div>
					<div class="gym-account-status">
						<span class="status-badge ${account.is_verified ? 'verified' : 'unverified'}">
							${account.is_verified ? '‚úì Verified' : '‚ö† Unverified'}
						</span>
						<span class="status-badge ${account.is_premium ? 'premium' : 'basic'}">
							${account.is_premium ? '‚≠ê Premium' : 'Basic'}
						</span>
					</div>
					<div class="admin-actions">
						${!account.is_verified ? `
							<button class="btn btn-success" onclick="approveGym('${account.user_id}')">Approve</button>
						` : `
							<button class="btn btn-danger" onclick="rejectGym('${account.user_id}')">Reject</button>
						`}
					</div>
					<div class="admin-actions">
						<div class="checkbox-wrapper">
							<input type="checkbox" id="premium-${account.user_id}" ${account.is_premium ? 'checked' : ''} 
								onchange="togglePremium('${account.user_id}', this.checked)">
							<label for="premium-${account.user_id}">Premium Access</label>
						</div>
					</div>
				</div>
			`).join('');
		}

		async function approveGym(userId) {
			try {
				const { data: { session } } = await supabase.auth.getSession();
				if (!session) {
					document.getElementById('login-container').style.display = 'flex';
					document.getElementById('admin-container').style.display = 'none';
					return;
				}

				const response = await fetch(`/api/admin/gym-accounts/${userId}/approve`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${session.access_token}`,
						'Content-Type': 'application/json'
					}
				});

				if (!response.ok) {
					if (response.status === 401) {
						document.getElementById('login-container').style.display = 'flex';
						document.getElementById('admin-container').style.display = 'none';
					} else {
						showError('Failed to approve gym account.');
					}
					return;
				}

				loadGymAccounts();
			} catch (error) {
				console.error('Error approving gym:', error);
				showError('Failed to approve gym account.');
			}
		}

		async function rejectGym(userId) {
			if (!confirm('Are you sure you want to reject this gym account? They will lose access to dashboard data.')) {
				return;
			}

			try {
				const { data: { session } } = await supabase.auth.getSession();
				if (!session) {
					document.getElementById('login-container').style.display = 'flex';
					document.getElementById('admin-container').style.display = 'none';
					return;
				}

				const response = await fetch(`/api/admin/gym-accounts/${userId}/reject`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${session.access_token}`,
						'Content-Type': 'application/json'
					}
				});

				if (!response.ok) {
					if (response.status === 401) {
						document.getElementById('login-container').style.display = 'flex';
						document.getElementById('admin-container').style.display = 'none';
					} else {
						showError('Failed to reject gym account.');
					}
					return;
				}

				loadGymAccounts();
			} catch (error) {
				console.error('Error rejecting gym:', error);
				showError('Failed to reject gym account.');
			}
		}

		async function togglePremium(userId, isPremium) {
			try {
				const { data: { session } } = await supabase.auth.getSession();
				if (!session) {
					document.getElementById('login-container').style.display = 'flex';
					document.getElementById('admin-container').style.display = 'none';
					return;
				}

				const response = await fetch(`/api/admin/gym-accounts/${userId}/premium`, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${session.access_token}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ is_premium: isPremium })
				});

				if (!response.ok) {
					if (response.status === 401) {
						document.getElementById('login-container').style.display = 'flex';
						document.getElementById('admin-container').style.display = 'none';
					} else {
						showError('Failed to update premium status.');
						loadGymAccounts(); // Reload to reset checkbox
					}
					return;
				}
			} catch (error) {
				console.error('Error toggling premium:', error);
				showError('Failed to update premium status.');
				loadGymAccounts(); // Reload to reset checkbox
			}
		}

		function showError(message) {
			const errorEl = document.getElementById('error-message');
			errorEl.innerHTML = message;
			errorEl.style.display = 'block';
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function formatDate(dateString) {
			if (!dateString) return 'N/A';
			const date = new Date(dateString);
			return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
		}

		// Filter tabs
		document.querySelectorAll('.filter-tab').forEach(tab => {
			tab.addEventListener('click', () => {
				document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
				tab.classList.add('active');
				currentFilter = tab.dataset.filter;
				loadGymAccounts();
			});
		});

		// Initialize on page load
		init();
	</script>
</body>
</html>
