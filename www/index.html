<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>GymVision AI</title>
	<link rel="manifest" href="static/manifest.webmanifest">
	<meta name="theme-color" content="#0f0f10">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="static/styles.css?v=3">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<!-- Supabase library - MUST load before app.js -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script>
		// Export createClient for Supabase v2
		const { createClient } = supabase;
		window.createClient = createClient;
		// Supabase config - hardcoded for Capacitor/iOS compatibility
		// Note: ANON key is safe to expose in frontend (designed to be public)
		window.SUPABASE_URL = "https://jugdkqzhcbqbjbvktqlz.supabase.co";
		window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp1Z2RrcXpoY2JxYmpidmt0cWx6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODI2NzIsImV4cCI6MjA4MDI1ODY3Mn0.rqCqBK14sOZvsxNUhIHIxaOnVMvdnNOjx_0YIXy1VIY";
		// Backend API URL - REQUIRED for Capacitor/iOS
		// Set this to your deployed Flask backend URL
		// Leave empty for local web development (will use relative paths)
		// For local testing: use "http://localhost:5004" (iOS Simulator) or "http://YOUR_MAC_IP:5004" (real iPhone)
		window.BACKEND_URL = "https://gymvision-ai.onrender.com"; // Change to "http://localhost:5004" for local testing
	</script>
	<script src="static/app.js?v=3" defer></script>
	<script>
		// Comprehensive error handling - prevent app crashes
		// Also show alerts for critical errors so we can debug
		window.addEventListener('error', function(e) {
			const errorMessage = e.message || e.error?.message || 'Unknown error';
			const errorFile = e.filename || e.error?.fileName || 'Unknown file';
			const errorLine = e.lineno || e.error?.lineNumber || 'Unknown line';
			
			console.error('JavaScript Error:', errorMessage, 'at', errorFile + ':' + errorLine);
			console.error('Full error object:', e);
			
			// Only show alert for critical errors in development/debug mode
			// And only if we have a meaningful error message
			if (errorMessage !== 'Unknown error' && errorMessage !== 'undefined' && 
			    (window.location.href.includes('localhost') || window.location.href.includes('capacitor://'))) {
				// Don't show alerts for common non-critical errors
				if (!errorMessage.includes('ResizeObserver') && 
				    !errorMessage.includes('Non-Error promise rejection') &&
				    !errorMessage.includes('Script error')) {
					alert('JS Error: ' + errorMessage + '\nFile: ' + errorFile + ':' + errorLine);
				}
			}
			// Prevent default error handling that might crash the app
			e.preventDefault();
			return true;
		}, true);
		
		window.addEventListener('unhandledrejection', function(e) {
			console.error('Unhandled Promise Rejection:', e.reason);
			// Show alert for promise rejections
			if (window.location.href.includes('localhost') || window.location.href.includes('capacitor://')) {
				alert('Promise Rejection: ' + (e.reason?.message || e.reason || 'Unknown'));
			}
			// Prevent default rejection handling
			e.preventDefault();
		});
		
		// Catch any synchronous errors during initialization
		try {
			// This will be executed after DOM loads
		} catch (error) {
			console.error('Initialization error:', error);
		}
	</script>
	<style>
		.auth-content {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}
		.auth-card {
			background: transparent;
			border-radius: 20px;
			padding: 40px 30px;
			width: 100%;
			max-width: 400px;
		}
		@media (max-width: 480px) {
			.auth-content {
				padding: 20px 16px;
			}
			.auth-card {
				padding: 30px 20px;
				border-radius: 16px;
			}
		}
		.auth-logo {
			text-align: center;
			margin-bottom: 30px;
		}
		.auth-logo img {
			width: 200px;
			height: auto;
			filter: brightness(0) invert(1);
		}
		.auth-title {
			color: #fff;
			font-size: 28px;
			font-weight: 700;
			text-align: center;
			margin-bottom: 10px;
		}
		.auth-subtitle {
			color: #888;
			text-align: center;
			margin-bottom: 30px;
			font-size: 14px;
		}
		.auth-role-toggle{
			display:flex;
			gap:8px;
			background:#252528;
			border:1px solid #333;
			border-radius:999px;
			padding:4px;
			margin:14px 0 18px;
		}
		.auth-role-btn{
			flex:1;
			background:transparent;
			border:none;
			color:#c9c9cf;
			padding:10px 12px;
			border-radius:999px;
			font-size:13px;
			font-weight:700;
			cursor:pointer;
		}
		.auth-role-btn.active{
			background:#8b5cf6;
			color:#fff;
		}
		.auth-role-btn:active{transform:scale(0.99)}
		.auth-form-group {
			margin-bottom: 20px;
		}
		.auth-label {
			color: #fff;
			font-size: 14px;
			font-weight: 500;
			margin-bottom: 8px;
			display: block;
		}
		.auth-input {
			width: 100%;
			padding: 14px 16px;
			background: #252528;
			border: 1px solid #333;
			border-radius: 12px;
			color: #fff;
			font-size: 16px;
			font-family: 'Inter', sans-serif;
			box-sizing: border-box;
		}
		.auth-input:focus {
			outline: none;
			border-color: #8b5cf6;
		}
		.auth-button {
			width: 100%;
			padding: 14px;
			background: #8b5cf6;
			color: #fff;
			border: none;
			border-radius: 12px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			margin-top: 10px;
			font-family: 'Inter', sans-serif;
			transition: background 0.2s;
		}
		.auth-button:hover {
			background: #7c3aed;
		}
		.auth-button:disabled {
			background: #555;
			cursor: not-allowed;
		}
		.auth-link {
			text-align: center;
			margin-top: 20px;
			color: #888;
			font-size: 14px;
		}
		.auth-link a {
			color: #8b5cf6;
			text-decoration: none;
			font-weight: 500;
			cursor: pointer;
		}
		.auth-link a:hover {
			text-decoration: underline;
		}
		.auth-error {
			background: #ef4444;
			color: #fff;
			padding: 12px;
			border-radius: 8px;
			margin-bottom: 20px;
			font-size: 14px;
			display: none;
		}
		.auth-error.show {
			display: block;
		}
	</style>
</head>
<body>
	<div id="app-loading-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0f0f10;z-index:99999;display:flex;align-items:center;justify-content:center;">
		<div style="text-align:center;color:#888;">
			<img src="static/logo.png" alt="GymVision" style="height:60px;width:auto;filter:brightness(0) invert(1);opacity:0.5;" />
		</div>
	</div>
	<div class="phone-shell">
		<div class="content hidden" id="home-content">
		<header class="topbar">
			<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
			<div class="icons streak">
				<img src="static/flame.png" alt="streak" class="streak-img" />
				<div id="streak-count" class="streak-count">0</div>
			</div>
		</header>
			<section class="card summary">
				<div class="summary-left">
					<div class="summary-number" id="result-title">Add an exercise</div>
					<button id="prediction-toggle" class="prediction-toggle hidden" type="button">Wrong exercise?</button>
				</div>
				<div class="summary-right">
					<div class="ring" id="confidence-ring"></div>
					<div class="ring-label">
						<div class="ring-label-title">Confidence</div>
						<div class="ring-label-value" id="ring-confidence">‚Äî</div>
					</div>
				</div>
			</section>

			<section class="card prediction-options hidden" id="prediction-options">
				<div class="prediction-options-title">Is this wrong? Pick another:</div>
				<div class="prediction-options-list" id="prediction-options-list"></div>
			</section>

			<section class="card prediction-options hidden" id="prediction-refine">
				<div class="prediction-options-title" id="prediction-refine-title">What are you doing exactly?</div>
				<div class="prediction-options-list" id="prediction-refine-list"></div>
			</section>

			<section class="quick-stats">
				<div class="qs-item"><span id="qs-muscle-1">‚Äî</span><label>Primary</label></div>
				<div class="qs-item"><span id="qs-muscle-2">‚Äî</span><label>Secondary</label></div>
				<div class="qs-item"><span id="qs-muscle-3">‚Äî</span><label>Support</label></div>
			</section>

			<section class="controls card">
				<div class="uploader">
					<video id="camera" autoplay playsinline class="camera"></video>
					<canvas id="snapshot" class="camera hidden"></canvas>
					<img id="manual-preview" class="manual-preview hidden" alt="Exercise reference" />

					<div class="home-exercise-selector">
						<div class="home-exercise-selector-header">
							<button type="button" id="home-open-exercise-selector" class="btn home-exercise-selector-btn">
								Select exercise
							</button>
						</div>
					</div>

					<!-- AI Detect temporarily disabled -->
					<!-- <div class="or-divider">or</div>
					<div class="btn-row">
						<label class="btn">
							<input type="file" id="fileInput" accept="image/*" capture="environment" hidden>
							Take photo
						</label>
						<button id="classify" class="btn primary" disabled>AI Detect</button>
					</div> -->
				</div>
			</section>

			<section class="card details">
				<h3 id="machine-name">No machine detected</h3>
				<div id="machine-custom" class="machine-custom hidden">
					<select id="machine-custom-select" class="hidden"></select>
					<input id="machine-custom-input" type="text" placeholder='Describe movement' autocomplete="off" />
				</div>
				<p class="confidence" id="confidence">Instruction video</p>
				<div class="video-wrap">
					<iframe id="video" src="" title="How-to video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
				</div>
			</section>

			<section class="recent-scans card">
				<h3 style="padding:16px 16px 8px;margin:0">Recent scans</h3>
				<div id="recent-scans-list" class="recent-scans-list"></div>
			</section>
		</div>

		<div class="content hidden" id="workouts-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<img src="static/flame.png" alt="streak" class="streak-img" />
					<div id="streak-count-workouts" class="streak-count">0</div>
				</div>
			</header>
			<div id="progress-heatmap" class="progress-heatmap-week-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:5px;padding:0 22px 0;justify-items:center;overflow:hidden;">
				<!-- Heatmap will be generated here -->
			</div>
			<button id="continue-workout-btn" class="btn primary start-workout-btn hidden" style="margin:22px 22px 12px;width:calc(100% - 44px);display:none">Continue workout</button>
			<div id="start-workout-buttons" style="display:flex;gap:10px;margin:20px 22px 20px;">
				<button id="ai-workout-btn" class="btn primary" style="flex:1;touch-action:manipulation;-webkit-touch-callout:none;" onclick="console.log('AI onclick fired'); if(window.startAIWorkout){window.startAIWorkout();}else{alert('App loading...');} return false;" ontouchstart="console.log('AI touchstart fired'); if(window.startAIWorkout){window.startAIWorkout();}else{alert('App loading...');} return false;">AI Workout</button>
				<button id="manual-workout-btn" class="btn" style="flex:1;touch-action:manipulation;-webkit-touch-callout:none;" onclick="console.log('Manual onclick fired'); if(window.startNewWorkout){window.startNewWorkout();}else{alert('App loading...');} return false;" ontouchstart="console.log('Manual touchstart fired'); if(window.startNewWorkout){window.startNewWorkout();}else{alert('App loading...');} return false;">Manual Workout</button>
			</div>
			<h2 style="padding:0 22px 12px;margin:0;font-size:24px;font-weight:800">Your Workouts <span id="workouts-count" style="color:var(--sub);font-size:14px">(0)</span></h2>
			<ul id="workouts-list" class="workouts-main-list"></ul>
		</div>

		<div class="content hidden" id="workout-builder-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<img src="static/flame.png" alt="streak" class="streak-img" />
					<div id="streak-count-workout-builder" class="streak-count">0</div>
				</div>
			</header>
			<div class="workout-builder-wrapper">
				<div class="workout-builder-top-buttons">
					<button id="back-to-workouts" class="btn">Back to workouts</button>
					<button id="save-workout" class="btn primary">Save Workout</button>
				</div>
				<section class="card workout" id="workout">
					<div class="workout-header">
						<div class="workout-header-top">
							<div class="workout-gym-header">
								<span class="location-icon workout-gym-pin" aria-hidden="true">
									<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M12 21s7-4.5 7-11a7 7 0 1 0-14 0c0 6.5 7 11 7 11Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
										<path d="M12 13.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4Z" stroke="currentColor" stroke-width="1.8"/>
									</svg>
								</span>
								<span id="workout-gym-name" class="workout-gym-name">Not set</span>
							</div>
							<div id="workout-timer" class="workout-timer-value">00:00</div>
						</div>
						<div class="workout-name-container">
							<label for="workout-name" class="workout-label">Workout name:</label>
							<input id="workout-name" class="workout-name" placeholder="Workout name" value="Workout" />
						</div>
					</div>
					<ul id="workout-list" class="workout-list"></ul>
					<div class="save-success hidden" id="save-success">‚úì Saved</div>
				</section>
			</div>
			
		</div>

		<div class="content hidden" id="progress-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<img src="static/flame.png" alt="streak" class="streak-img" />
					<div id="streak-count-progress" class="streak-count">0</div>
				</div>
			</header>

			<section class="card progress-muscle-card">
				<div class="progress-muscle-header">
					<h3>Muscle Focus</h3>
					<div class="progress-muscle-filters" role="group" aria-label="Range filter">
						<button class="progress-filter-btn active" data-range="week">Week</button>
						<button class="progress-filter-btn" data-range="month">Month</button>
						<button class="progress-filter-btn" data-range="year">Year</button>
						<button class="progress-filter-btn" data-range="all">All</button>
					</div>
				</div>
				<div class="progress-muscle-content">
					<div class="progress-muscle-chart-wrapper">
						<canvas id="progress-muscle-chart"></canvas>
						<div id="progress-muscle-empty" class="progress-empty">No workouts in this range</div>
						<div id="progress-muscle-center" class="progress-muscle-center-label"></div>
					</div>
					<ul id="progress-muscle-legend" class="progress-muscle-legend"></ul>
				</div>
			</section>

			<section class="card progress-exercise-insights-card">
				<div class="progress-pr-header">
					<h3>Exercise Insights</h3>
				</div>
				<div class="progress-pr-selector">
					<button type="button" id="progress-open-exercise-selector" class="btn progress-pr-select-btn">
						Select exercise
					</button>
				</div>
				<div id="progress-pr-results" class="progress-pr-results">
				</div>
			</section>

			<section class="card progress-pr-timeline-card">
				<div class="progress-pr-header">
					<h3>Personal Records Timeline</h3>
				</div>
				<div id="progress-pr-timeline" class="progress-pr-timeline">
					<div class="progress-pr-empty">No personal records yet. Complete workouts to see your PRs!</div>
				</div>
			</section>

			<section class="card progress-overload-card">
				<div class="progress-pr-header">
					<h3>Progressive Overload Tracker</h3>
				</div>
				<div id="progress-overload-tracker" class="progress-overload-tracker">
					<div class="progress-pr-empty">Complete more workouts to track your progress.</div>
				</div>
			</section>

			<section class="card progress-heatmap-monthly-card">
				<div class="progress-heatmap-monthly-header">
					<button id="progress-heatmap-prev-month" class="progress-heatmap-nav-btn">‚Üê</button>
					<h3 id="progress-heatmap-month-label">January 2024</h3>
					<button id="progress-heatmap-next-month" class="progress-heatmap-nav-btn">‚Üí</button>
				</div>
				<div id="progress-heatmap-monthly" class="progress-heatmap-monthly-grid">
					<!-- Monthly heatmap will be generated here -->
				</div>
			</section>

			<section class="card progress-orm-calculator-card">
				<div class="progress-orm-header">
					<h3>One Rep Max Calculator</h3>
				</div>
				<div class="progress-orm-content">
					<div class="progress-orm-inputs">
						<div class="progress-orm-input-group">
							<label for="orm-weight" class="progress-orm-label">Weight</label>
							<div class="progress-orm-input-wrapper">
								<input type="number" id="orm-weight" placeholder="0" step="0.1" min="0" />
								<span id="orm-unit-label" class="progress-orm-unit">kg</span>
							</div>
						</div>
						<div class="progress-orm-input-group">
							<label for="orm-reps" class="progress-orm-label">Reps</label>
							<input type="number" id="orm-reps" placeholder="0" step="1" min="1" max="30" />
						</div>
					</div>
					<div class="progress-orm-result">
						<div class="progress-orm-result-label">Estimated 1RM</div>
						<div class="progress-orm-result-value">
							<span id="orm-result">‚Äî</span>
							<span id="orm-result-unit" class="progress-orm-unit">kg</span>
						</div>
					</div>
				</div>
			</section>

			<section class="card progress-chart-card">
				<div class="progress-chart-header">
					<h3>Weight Progress</h3>
					<input type="date" id="progress-date" class="progress-chart-date-input" />
				</div>
				<div class="progress-chart-wrapper" data-unit="kg">
					<canvas id="progress-chart"></canvas>
					<div id="progress-empty" class="progress-empty">No weight data yet</div>
					<div id="progress-y-labels" class="progress-y-labels"></div>
					<div id="progress-x-labels" class="progress-x-labels"></div>
					<div id="progress-tooltip" class="progress-tooltip"></div>
				</div>
				<form id="progress-form" class="progress-inline-form">
					<div class="progress-weight-group">
						<label for="progress-weight" class="progress-weight-label">Weight</label>
						<div class="progress-weight-input-wrapper">
							<input type="number" id="progress-weight" placeholder="0" step="0.1" min="0" />
							<span id="progress-unit-label" class="progress-inline-unit">kg</span>
						</div>
					</div>
					<button type="submit" class="btn primary progress-inline-submit">Add</button>
				</form>
			</section>

			
		</div>

		<div class="content hidden" id="settings-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<img src="static/flame.png" alt="streak" class="streak-img" />
					<div id="streak-count-settings" class="streak-count">0</div>
				</div>
			</header>
			<div style="padding: 22px;">
				<!-- Profile Card with Statistics -->
				<div class="settings-profile-card">
					<div class="settings-profile-header">
						<div class="settings-avatar">
							<svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
								<circle cx="30" cy="30" r="30" fill="rgba(255,255,255,0.2)"/>
								<circle cx="30" cy="24" r="6" stroke="#fff" stroke-width="2" fill="none"/>
								<path d="M20 42C20 36 25 32 30 32C35 32 40 36 40 42" stroke="#fff" stroke-width="2" stroke-linecap="round" fill="none"/>
							</svg>
						</div>
						<div class="settings-profile-info">
							<div class="settings-username" id="settings-username">‚Äî</div>
							<div class="settings-email" id="settings-email">‚Äî</div>
						</div>
					</div>
					<div class="settings-stats-grid">
						<div class="settings-stat-box">
							<div class="settings-stat-value" id="settings-stat-streak">0</div>
							<div class="settings-stat-label">Streak</div>
						</div>
						<div class="settings-stat-box">
							<div class="settings-stat-value" id="settings-stat-workouts">0</div>
							<div class="settings-stat-label">Workouts</div>
						</div>
						<div class="settings-stat-box">
							<div class="settings-stat-value" id="settings-stat-hours">0</div>
							<div class="settings-stat-label">Hours</div>
						</div>
					</div>
					<!-- Gym input (moved into the purple profile card) -->
					<div class="settings-profile-gym">
						<div class="settings-profile-gym-header">
							<img src="static/nav/dumbell.png" class="settings-profile-gym-icon" alt="" aria-hidden="true" />
							<span class="settings-profile-gym-label">Gym</span>
						</div>
						<div class="settings-profile-gym-field">
							<input type="text" id="settings-gym-input" class="settings-gym-input" placeholder="Search gym..." autocomplete="off">
							<button type="button" id="settings-gym-clear" class="settings-gym-clear" aria-label="Clear gym" title="Clear">√ó</button>
							<div id="gym-autocomplete-dropdown" class="gym-autocomplete-dropdown" style="display: none;"></div>
						</div>
					</div>
				</div>
				
				<!-- Settings Options -->
				<div class="settings-options">
					<!-- Notifications Toggle -->
					<div class="settings-option-item">
						<div class="settings-option-left">
							<img src="static/images/notification-icon.png?v=2" alt="Notifications" class="settings-icon" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='block';">
							<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:none; width:20px; height:20px; color:#dfe0e6; flex-shrink:0;">
								<path d="M10 2C8.9 2 8 2.9 8 4V5.58C6.84 6.42 6 7.85 6 9.5V13L4 15V16H16V15L14 13V9.5C14 7.85 13.16 6.42 12 5.58V4C12 2.9 11.1 2 10 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
								<path d="M8 16V17C8 18.1 8.9 19 10 19C11.1 19 12 18.1 12 17V16" stroke="currentColor" stroke-width="1.5" fill="none"/>
							</svg>
							<span class="settings-option-label">Notifications</span>
						</div>
						<div class="settings-option-right">
							<label class="settings-toggle">
								<input type="checkbox" id="settings-notifications-toggle">
								<span class="settings-toggle-slider">
									<span class="settings-toggle-label-left"></span>
									<span class="settings-toggle-label-right"></span>
								</span>
							</label>
						</div>
					</div>
					
					
					<!-- Rest Timer Toggle -->
					<div class="settings-option-item">
						<div class="settings-option-left">
							<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
								<circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="1.5" fill="none"/>
								<path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/>
							</svg>
							<span class="settings-option-label">Rest Timer</span>
						</div>
						<div class="settings-option-right">
							<label class="settings-toggle">
								<input type="checkbox" id="settings-rest-timer-toggle">
								<span class="settings-toggle-slider">
									<span class="settings-toggle-label-left"></span>
									<span class="settings-toggle-label-right"></span>
								</span>
							</label>
						</div>
					</div>
					
					<!-- Data Collection Consent -->
					<div class="settings-option-item">
						<div class="settings-option-left">
							<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M10 2L3 7V9C3 13 6 16.5 10 17.5C14 16.5 17 13 17 9V7L10 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
								<path d="M7 10L9 12L13 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
							</svg>
							<div class="settings-option-label-wrapper">
								<div class="settings-option-label-row">
									<span class="settings-option-label">Data collection</span>
									<button type="button" id="settings-data-consent-info" class="settings-info-btn" aria-label="About data collection" title="About">i</button>
								</div>
							</div>
						</div>
						<div class="settings-option-right">
							<label class="settings-toggle">
								<input type="checkbox" id="settings-data-consent-toggle">
								<span class="settings-toggle-slider">
									<span class="settings-toggle-label-left"></span>
									<span class="settings-toggle-label-right"></span>
								</span>
							</label>
						</div>
					</div>
					
				</div>
				
				<!-- Action Buttons -->
				<div class="settings-action-buttons">
					<button id="logout-btn" class="settings-logout-btn">
						Log Out
					</button>
					<button id="delete-account-btn" class="settings-delete-account-btn">
						Delete Account
					</button>
				</div>
			</div>
		</div>

		<div class="content hidden" id="vision-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<img src="static/flame.png" alt="streak" class="streak-img" />
					<div id="streak-count-vision" class="streak-count">0</div>
				</div>
			</header>
			<div style="padding: 22px; display: flex; flex-direction: column; height: calc(100% - 60px);">
				<div id="vision-chat-messages" style="flex: 1; overflow-y: auto; margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px;">
					<div class="vision-message vision-message-bot">
						<div class="vision-avatar">
							<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<circle cx="12" cy="12" r="10" stroke="var(--accent)" stroke-width="2" fill="rgba(124,92,255,0.1)"/>
								<circle cx="12" cy="12" r="4" fill="var(--accent)"/>
								<path d="M2 12s3-4 10-4 10 4 10 4" stroke="var(--accent)" stroke-width="2" fill="none" stroke-linecap="round"/>
							</svg>
						</div>
					<div class="vision-message-content">
						Hi! I'm Vision, your personal AI workout builder. Tell me what you want to train and I'll create it instantly.
					</div>
					</div>
				</div>
				<div class="vision-quick-suggestions">
					<button type="button" class="vision-example-btn" data-example="Create a 5 exercise push workout">Create a 5 exercise push workout</button>
					<button type="button" class="vision-example-btn" data-example="Full body workout">Full body workout</button>
					<button type="button" class="vision-example-btn" data-example="Just pushups workout">Just pushups workout</button>
					<button type="button" class="vision-example-btn" data-example="Legs mainly quads workout">Legs mainly quads workout</button>
				</div>
				<div style="display: flex; gap: 8px;">
					<input type="text" id="vision-input" placeholder="What do you want to train today?" style="flex: 1; background: #1a1a1d; border: 1px solid #2b2b34; border-radius: 12px; padding: 12px 16px; color: #fff; font-size: 14px; font-family: 'Inter', sans-serif;" />
					<button id="vision-send-btn" style="background: var(--accent); border: none; border-radius: 12px; padding: 12px 24px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif;">Send</button>
				</div>
				<div style="margin-top: 8px; margin-bottom: -22px; padding: 0 4px;">
					<p style="margin: 0; font-size: 12px; color: #888; font-family: 'Inter', sans-serif;">Add "workout" to you prompt for optimal results</p>
				</div>
			</div>
		</div>

	<div id="exercise-selector" class="exercise-selector hidden">
		<div class="exercise-selector-panel">
			<div class="exercise-selector-header">
				<h3>Select exercise</h3>
				<button id="exercise-selector-close" class="exercise-selector-close" type="button">‚úï</button>
			</div>
			<div class="exercise-selector-search">
				<input type="text" id="exercise-selector-search" placeholder="Search exercise..." autocomplete="off" />
			</div>
			<div class="exercise-selector-muscles-row">
				<div class="exercise-selector-muscles" id="exercise-selector-muscles"></div>
			</div>
			<div class="exercise-selector-or">or</div>
			<div class="exercise-selector-ai-detect">
				<button type="button" id="exercise-selector-ai-detect" class="btn primary">
					AI-detect
				</button>
				<input type="file" id="exercise-selector-file" accept="image/*" hidden>
			</div>
			<div id="exercise-selector-predictions" class="exercise-selector-predictions"></div>
			<div class="exercise-selector-results" id="exercise-selector-results"></div>
		</div>
	</div>

	<!-- AI Detect Chat Modal -->
	<div id="ai-detect-chat-modal" class="ai-detect-chat-modal hidden">
		<div class="ai-detect-chat-backdrop"></div>
		<div class="ai-detect-chat-content">
			<div class="ai-detect-chat-header">
				<h3>AI Exercise Detection</h3>
				<button id="ai-detect-chat-close" class="ai-detect-chat-close" type="button">‚úï</button>
			</div>
			<div id="ai-detect-chat-messages" class="ai-detect-chat-messages">
				<div class="ai-detect-chat-message ai-detect-chat-message-bot">
					<div class="ai-detect-chat-avatar">ü§ñ</div>
					<div class="ai-detect-chat-text">Upload a photo of the exercise machine or movement, and I'll identify it for you!</div>
				</div>
			</div>
			<div class="ai-detect-chat-input-area">
				<label for="ai-detect-chat-file" class="ai-detect-chat-file-label">
					<input type="file" id="ai-detect-chat-file" accept="image/*" hidden>
					<span class="ai-detect-chat-file-button">üì∑ Foto maken of uploaden</span>
				</label>
			</div>
		</div>
	</div>

	<!-- AI Detect Error Modal -->
	<div id="ai-detect-error-modal" class="ai-detect-error-modal hidden">
		<div class="ai-detect-error-backdrop"></div>
		<div class="ai-detect-error-content">
			<h3 class="ai-detect-error-title">We couldn't detect an exercise from this photo.</h3>
			<p class="ai-detect-error-message">Try taking a clearer picture of the machine or movement.</p>
			<button id="ai-detect-error-try-again" class="ai-detect-error-button" type="button">Try again</button>
		</div>
	</div>

	<div id="exercise-video-modal" class="video-modal hidden">
		<div class="video-modal-backdrop"></div>
		<div class="video-modal-content">
			<button id="exercise-video-close" class="video-modal-close" type="button">‚úï</button>
			<div class="video-modal-frame">
				<iframe id="exercise-video-frame" src="" title="Exercise video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
			</div>
		</div>
	</div>

	<!-- Custom Exercise Modal -->
	<div id="custom-exercise-modal" class="custom-exercise-modal hidden">
		<div class="custom-exercise-backdrop"></div>
		<div class="custom-exercise-content">
			<div class="custom-exercise-header">
				<h3>Create Custom Exercise</h3>
				<button id="custom-exercise-close" class="custom-exercise-close" type="button">‚úï</button>
			</div>
			<div class="custom-exercise-form">
				<div class="custom-exercise-field">
					<label for="custom-exercise-name">Exercise Name</label>
					<input type="text" id="custom-exercise-name" placeholder="Enter exercise name" autocomplete="off">
				</div>
				<div class="custom-exercise-field">
					<label>Exercise Type</label>
					<div class="custom-exercise-type-options">
						<button type="button" class="custom-exercise-type-btn active" data-type="weight-reps">
							Weights
						</button>
						<button type="button" class="custom-exercise-type-btn" data-type="bodyweight">
							Bodyweight
						</button>
						<button type="button" class="custom-exercise-type-btn" data-type="cardio">
							Cardio
						</button>
					</div>
				</div>
				<div class="custom-exercise-field" id="custom-exercise-muscle-field">
					<label for="custom-exercise-muscle">Primary Muscle</label>
					<select id="custom-exercise-muscle" class="custom-exercise-muscle-select">
						<option value="">Select muscle...</option>
						<option value="chest">Chest</option>
						<option value="back">Back</option>
						<option value="shoulders">Shoulders</option>
						<option value="biceps">Biceps</option>
						<option value="triceps">Triceps</option>
						<option value="quads">Quads</option>
						<option value="hamstrings">Hamstrings</option>
						<option value="glutes">Glutes</option>
						<option value="calves">Calves</option>
						<option value="abs">Abs</option>
						<option value="forearms">Forearms</option>
					</select>
				</div>
				<div class="custom-exercise-actions">
					<button type="button" id="custom-exercise-cancel" class="btn">Cancel</button>
					<button type="button" id="custom-exercise-add" class="btn primary">Add to Workout</button>
				</div>
			</div>
		</div>
	</div>

		<div class="content hidden" id="login-content">
			<div class="auth-content">
				<div class="auth-card">
					<div class="auth-logo">
						<img src="static/logo.png" alt="GymVision AI" />
					</div>
					<h1 class="auth-title">Welcome Back</h1>
					<p class="auth-subtitle">Sign in to continue</p>

					<div class="auth-role-toggle" id="auth-role-toggle-login" aria-label="Account type">
						<button type="button" class="auth-role-btn" data-role="user">User</button>
						<button type="button" class="auth-role-btn" data-role="gym">Gym</button>
					</div>
					
					<div class="auth-error" id="login-error-message"></div>
					
					<form id="login-form">
						<div class="auth-form-group">
							<label class="auth-label" for="login-email">Email</label>
							<input type="email" id="login-email" class="auth-input" placeholder="your@email.com" required autocomplete="email">
						</div>
						<div class="auth-form-group">
							<label class="auth-label" for="login-password">Password</label>
							<input type="password" id="login-password" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
							<div style="text-align: right; margin-top: 8px;">
								<a href="#" id="forgot-password-link" style="color: #8b5cf6; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-block; padding: 4px 0;">Forgot password?</a>
							</div>
						</div>
						<button type="submit" class="auth-button" id="login-submit-btn">Sign In</button>
					</form>
					
					<div class="auth-link">
						Don't have an account? <a href="#" id="show-register-link">Sign up</a>
					</div>
				</div>
			</div>
		</div>

		<div class="content hidden" id="register-content">
			<div class="auth-content">
				<div class="auth-card">
					<div class="auth-logo">
						<img src="static/logo.png" alt="GymVision AI" />
					</div>
					<h1 class="auth-title">Create Account</h1>
					<p class="auth-subtitle">Start your fitness journey</p>

					<div class="auth-role-toggle" id="auth-role-toggle-register" aria-label="Account type">
						<button type="button" class="auth-role-btn" data-role="user">User</button>
						<button type="button" class="auth-role-btn" data-role="gym">Gym</button>
					</div>
					
					<div class="auth-error" id="register-error-message"></div>
					
					<form id="register-form">
						<div class="auth-form-group" id="register-gym-name-group" style="display:none;">
							<label class="auth-label" for="register-gym-name">Gym name</label>
							<input type="text" id="register-gym-name" class="auth-input" placeholder="SportCity Kampen">
						</div>
						<div class="auth-form-group">
							<label class="auth-label" for="register-email">Email</label>
							<input type="email" id="register-email" class="auth-input" placeholder="your@email.com" required autocomplete="email">
						</div>
						<div class="auth-form-group" id="register-username-group">
							<label class="auth-label" for="register-username">Username</label>
							<input type="text" id="register-username" class="auth-input" placeholder="username" required autocomplete="username" minlength="3">
						</div>
						<div class="auth-form-group">
							<label class="auth-label" for="register-password">Password</label>
							<input type="password" id="register-password" class="auth-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password" minlength="6">
						</div>
						<div class="auth-form-group" id="register-contact-name-group" style="display:none;">
							<label class="auth-label" for="register-contact-name">Contact name</label>
							<input type="text" id="register-contact-name" class="auth-input" placeholder="John Doe">
						</div>
						<div class="auth-form-group" id="register-contact-phone-group" style="display:none;">
							<label class="auth-label" for="register-contact-phone">Contact phone</label>
							<input type="tel" id="register-contact-phone" class="auth-input" placeholder="+31 6 12345678">
						</div>
						<button type="submit" class="auth-button" id="register-submit-btn">Sign Up</button>
					</form>
					
					<div class="auth-link">
						Already have an account? <a href="#" id="show-login-link">Sign in</a>
					</div>
				</div>
			</div>
		</div>

		<div class="content hidden" id="gym-dashboard-content">
			<header class="topbar">
				<div class="brand brand-logo"><img src="static/logo.png" alt="GymVision" /></div>
				<div class="icons streak">
					<button type="button" id="gym-dashboard-logout" class="btn" style="padding:8px 12px;font-size:13px;min-width:auto;">Logout</button>
				</div>
			</header>
			<div style="padding: 22px;">
				<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; gap: 14px;">
					<h2 id="gym-dashboard-title" style="margin:0;font-size:22px;font-weight:800;flex:1;">Gym Dashboard</h2>
					<div style="display: flex; align-items: center; gap: 10px;">
						<label for="gym-dashboard-date" style="color: #c9cad6; font-size: 12px; font-weight: 600; white-space: nowrap;">Date:</label>
						<input type="date" id="gym-dashboard-date" style="max-width: 136px; padding: 6px 10px; background: #15151a; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 8px; color: #fff; font-size: 13px; font-weight: 600; font-family: 'Inter', sans-serif; box-sizing: border-box;">
					</div>
				</div>
				<div id="gym-dashboard-error" class="auth-error"></div>
				<div id="gym-dashboard-loading" class="progress-empty" style="padding:18px 0;">Loading dashboard...</div>

				<div id="gym-dashboard-panels" class="hidden">
					<div class="settings-stats-grid" style="margin-bottom: 44px;">
						<div class="settings-stat-box" style="background:linear-gradient(135deg,#18181d,#121215);border:1px solid rgba(255,255,255,0.06);">
							<div class="settings-stat-value" id="gym-dashboard-total-users">0</div>
							<div class="settings-stat-label">Users</div>
						</div>
						<div class="settings-stat-box" style="background:linear-gradient(135deg,#18181d,#121215);border:1px solid rgba(255,255,255,0.06);">
							<div class="settings-stat-value" id="gym-dashboard-total-workouts">0</div>
							<div class="settings-stat-label">Workouts</div>
						</div>
						<div class="settings-stat-box" style="background:linear-gradient(135deg,#18181d,#121215);border:1px solid rgba(255,255,255,0.06);">
							<div class="settings-stat-value" id="gym-dashboard-total-exercises">0</div>
							<div class="settings-stat-label">Exercises</div>
						</div>
					</div>
					<div class="gym-dashboard-controls" style="margin: 16px 0 14px;">
						<div class="gym-period-toggle" role="tablist" aria-label="Dashboard period">
							<button type="button" class="gym-period-btn" data-period="week" aria-selected="false">Week</button>
							<button type="button" class="gym-period-btn" data-period="month" aria-selected="false">Month</button>
							<button type="button" class="gym-period-btn" data-period="year" aria-selected="false">Year</button>
							<button type="button" class="gym-period-btn" data-period="all" aria-selected="false">All</button>
						</div>
					</div>

					<section class="card" style="margin:14px 0 0;">
						<div style="padding:18px 18px 10px;font-weight:800;">Most used machines (sets)</div>
						<div id="gym-dashboard-chart-machines" class="gym-chart"></div>
					</section>

					<section class="card" style="margin:14px 0 0;">
						<div style="padding:18px 18px 10px;font-weight:800;display:flex;align-items:center;justify-content:space-between;gap:10px;">
							<span>Peak times</span>
							<div class="gym-mini-toggle" role="tablist" aria-label="Peak times view">
								<button type="button" class="gym-mini-btn active" data-peak="hours" aria-selected="true">Hours</button>
								<button type="button" class="gym-mini-btn" data-peak="days" aria-selected="false">Days</button>
							</div>
						</div>
						<div id="gym-dashboard-chart-peak" class="gym-chart"></div>
					</section>

					<section class="card" style="margin:14px 0 0;">
						<div style="padding:18px 18px 10px;font-weight:800;">Top muscles (sets)</div>
						<div id="gym-dashboard-chart-muscles" style="padding:0 18px 18px;">
							<div class="progress-muscle-content">
								<div class="progress-muscle-chart-wrapper">
									<canvas id="gym-muscle-chart"></canvas>
									<div id="gym-muscle-empty" class="progress-muscle-empty">No data yet</div>
									<div id="gym-muscle-center" class="progress-muscle-center-label"></div>
								</div>
								<ul id="gym-muscle-legend" class="progress-muscle-legend"></ul>
							</div>
						</div>
					</section>

					<section class="card" style="margin:14px 0 0;">
						<div style="padding:18px 18px 10px;font-weight:800;">Weights/Cardio Ratio</div>
						<div id="gym-dashboard-chart-categories" style="padding:0 18px 18px;">
							<div class="progress-muscle-content">
								<div class="progress-muscle-chart-wrapper">
									<canvas id="gym-categories-chart"></canvas>
									<div id="gym-categories-empty" class="progress-muscle-empty">No data yet</div>
									<div id="gym-categories-center" class="progress-muscle-center-label"></div>
								</div>
								<ul id="gym-categories-legend" class="progress-muscle-legend"></ul>
							</div>
						</div>
					</section>

					<!-- Delete Account Section - Always visible -->
					<section class="card" style="margin:14px 0 0;border:1px solid rgba(124,92,255,0.2);">
						<div style="padding:18px;">
							<div style="font-weight:800;margin-bottom:12px;color:#7c5cff;">Delete Account</div>
							<p style="color:#888;font-size:14px;margin-bottom:16px;">Permanently delete your gym account. This action cannot be undone.</p>
							<button type="button" id="gym-dashboard-delete-account" class="btn" style="background:rgba(124,92,255,0.15);border:1px solid rgba(124,92,255,0.3);color:#7c5cff;width:100%;padding:12px;font-weight:600;">Delete Account</button>
						</div>
					</section>
				</div>
			</div>
		</div>

	<footer class="navbar" id="main-navbar" style="display: none;">
			<button class="nav-btn active" data-tab="workouts" onclick="console.log('Nav workouts clicked'); if(window.switchTab){window.switchTab('workouts');} return false;" ontouchstart="console.log('Nav workouts touched'); if(window.switchTab){window.switchTab('workouts');} return false;" style="touch-action:manipulation;-webkit-touch-callout:none;">
				<img src="static/nav/dumbell.png" alt="Workouts" class="nav-icon" />
				<span>Workouts</span>
			</button>
			<button class="nav-btn" data-tab="progress" onclick="console.log('Nav progress clicked'); if(window.switchTab){window.switchTab('progress');} return false;" ontouchstart="console.log('Nav progress touched'); if(window.switchTab){window.switchTab('progress');} return false;" style="touch-action:manipulation;-webkit-touch-callout:none;">
				<img src="static/nav/progress.png" alt="Progress" class="nav-icon" />
				<span>Progress</span>
			</button>
			<button class="nav-btn" data-tab="settings" onclick="console.log('Nav settings clicked'); if(window.switchTab){window.switchTab('settings');} return false;" ontouchstart="console.log('Nav settings touched'); if(window.switchTab){window.switchTab('settings');} return false;" style="touch-action:manipulation;-webkit-touch-callout:none;">
				<img src="static/nav/settings.png" alt="Settings" class="nav-icon" />
				<span>Settings</span>
			</button>
		</footer>
	</div>

	<!-- Capacitor Core - MUST load before app.js for iOS -->
	<script type="module" src="https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/capacitor.js"></script>
	<!-- Main app.js -->
	<script src="static/app.js"></script>
	<script>
		// Service worker for PWA (safe to leave)
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('static/sw.js').catch(()=>{});
		}
	</script>
	
	<!-- Rest Timer Overlay (outside phone-shell for proper z-index) -->
	<div id="rest-timer-overlay" class="rest-timer-overlay hidden">
		<div class="rest-timer-container">
			<div class="rest-timer-header">
				<h3>Rest Timer</h3>
				<button class="rest-timer-close" id="rest-timer-close">√ó</button>
			</div>
			<div class="rest-timer-display">
				<div class="rest-timer-time" id="rest-timer-time">00:00</div>
				<div class="rest-timer-label">Rest Time</div>
			</div>
			<div class="rest-timer-controls">
				<button class="rest-timer-btn" id="rest-timer-start">Start</button>
				<div class="rest-timer-adjust-buttons">
					<button class="rest-timer-btn-small" id="rest-timer-add-30sec">+ 30 sec</button>
					<button class="rest-timer-btn-small" id="rest-timer-subtract-30sec">- 30 sec</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Forgot Password Modal -->
	<div id="forgot-password-modal" class="forgot-password-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
		<div class="forgot-password-content" style="background: #1a1a1b; border-radius: 16px; padding: 30px; width: 90%; max-width: 400px; border: 1px solid #333;">
			<button class="forgot-password-close" id="close-forgot-modal" style="background: transparent; border: none; color: #888; font-size: 24px; cursor: pointer; float: right; line-height: 1;">&times;</button>
			<h3 style="color: #fff; font-size: 20px; margin-bottom: 16px;">Reset Password</h3>
			<p style="color: #888; font-size: 14px; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
			<div class="auth-error" id="forgot-error-message" style="display: none;"></div>
			<div class="auth-success" id="forgot-success-message" style="display: none; background: #10b981; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;"></div>
			<form id="forgot-password-form">
				<div class="auth-form-group">
					<label class="auth-label" for="forgot-email">Email</label>
					<input type="email" id="forgot-email" class="auth-input" placeholder="your@email.com" required autocomplete="email">
				</div>
				<button type="submit" class="auth-button" id="forgot-submit-btn">Send Reset Link</button>
			</form>
		</div>
	</div>
	
	<script>
		// Forgot Password functionality
		document.addEventListener('DOMContentLoaded', () => {
			const forgotLink = document.getElementById('forgot-password-link');
			const forgotModal = document.getElementById('forgot-password-modal');
			const closeModal = document.getElementById('close-forgot-modal');
			const forgotForm = document.getElementById('forgot-password-form');
			const forgotError = document.getElementById('forgot-error-message');
			const forgotSuccess = document.getElementById('forgot-success-message');
			const forgotSubmitBtn = document.getElementById('forgot-submit-btn');
			
			if (!forgotLink || !forgotModal) return; // Elements not found, skip
			
			// Open modal - use both click and touchstart for better iOS support
			const openModal = (e) => {
				if (e) {
					e.preventDefault();
					e.stopPropagation();
				}
				forgotModal.style.display = 'flex';
				// Focus on email input
				const emailInput = document.getElementById('forgot-email');
				if (emailInput) {
					setTimeout(() => emailInput.focus(), 100);
				}
			};
			
			forgotLink.addEventListener('click', openModal);
			forgotLink.addEventListener('touchend', (e) => {
				e.preventDefault();
				openModal(e);
			});
			
			// Close modal
			if (closeModal) {
				closeModal.addEventListener('click', () => {
					forgotModal.style.display = 'none';
					if (forgotError) forgotError.style.display = 'none';
					if (forgotSuccess) forgotSuccess.style.display = 'none';
					if (forgotForm) forgotForm.reset();
				});
			}
			
			// Close on backdrop click
			forgotModal.addEventListener('click', (e) => {
				if (e.target === forgotModal) {
					forgotModal.style.display = 'none';
					if (forgotError) forgotError.style.display = 'none';
					if (forgotSuccess) forgotSuccess.style.display = 'none';
					if (forgotForm) forgotForm.reset();
				}
			});
			
			// Handle form submission
			if (forgotForm) {
				forgotForm.addEventListener('submit', async (e) => {
					e.preventDefault();
					
					const email = document.getElementById('forgot-email').value.trim();
					if (!email) {
						if (forgotError) {
							forgotError.textContent = 'Please enter your email address';
							forgotError.style.display = 'block';
						}
						if (forgotSuccess) forgotSuccess.style.display = 'none';
						return;
					}
					
					if (forgotSubmitBtn) {
						forgotSubmitBtn.disabled = true;
						forgotSubmitBtn.textContent = 'Sending...';
					}
					if (forgotError) forgotError.style.display = 'none';
					if (forgotSuccess) forgotSuccess.style.display = 'none';
					
					try {
						// Initialize Supabase if needed
						if (typeof window.createClient === 'undefined') {
							throw new Error('Supabase not loaded. Please refresh the page.');
						}
						
						if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
							throw new Error('Supabase configuration missing');
						}
						
						const sb = window.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
						
						// Determine redirect URL - ALWAYS use backend URL for consistency
						// This ensures the same URL is used in browser and Xcode/app
						let redirectUrl;
						// In app context, window.location.origin might be "capacitor://localhost"
						// So we always use BACKEND_URL which is explicitly set
					const backendUrl = window.BACKEND_URL || 'https://gymvision-ai.onrender.com';
					
					// Always use the backend URL for consistency - this must match exactly
					// what's configured in Supabase redirect URLs
					redirectUrl = `${backendUrl}/reset-password`;
						
						console.log('[FORGOT PASSWORD] Using redirect URL:', redirectUrl);
						console.log('[FORGOT PASSWORD] Is native platform:', window.Capacitor && window.Capacitor.isNativePlatform());
						console.log('[FORGOT PASSWORD] window.location.origin:', window.location.origin);
						console.log('[FORGOT PASSWORD] BACKEND_URL:', window.BACKEND_URL);
						
						console.log('[FORGOT PASSWORD] Sending reset email to:', email);
						console.log('[FORGOT PASSWORD] Redirect URL:', redirectUrl);
						console.log('[FORGOT PASSWORD] Supabase URL:', window.SUPABASE_URL);
						
						// Send password reset email
						const { data, error } = await sb.auth.resetPasswordForEmail(email, {
							redirectTo: redirectUrl,
							emailRedirectTo: redirectUrl
						});
						
						if (error) {
							console.error('[FORGOT PASSWORD] Error:', error);
							// Provide more helpful error messages
							let errorMsg = error.message || 'Failed to send reset email';
							if (error.message && error.message.includes('rate limit')) {
								errorMsg = 'Too many requests. Please wait a few minutes and try again.';
							} else if (error.message && error.message.includes('not found')) {
								errorMsg = 'No account found with this email address.';
							} else if (error.message && error.message.includes('email')) {
								errorMsg = 'Invalid email address. Please check and try again.';
							}
							throw new Error(errorMsg);
						}
						
						console.log('[FORGOT PASSWORD] Success! Email sent:', data);
						
						// Success
						if (forgotSuccess) {
							forgotSuccess.textContent = 'Password reset email sent! Check your inbox and click the link to reset your password.';
							forgotSuccess.style.display = 'block';
						}
						if (forgotError) forgotError.style.display = 'none';
						
						// Close modal after 3 seconds
						setTimeout(() => {
							forgotModal.style.display = 'none';
							if (forgotSuccess) forgotSuccess.style.display = 'none';
							if (forgotForm) forgotForm.reset();
						}, 3000);
						
					} catch (error) {
						if (forgotError) {
							forgotError.textContent = error.message || 'Failed to send reset email. Please try again.';
							forgotError.style.display = 'block';
						}
						if (forgotSuccess) forgotSuccess.style.display = 'none';
					} finally {
						if (forgotSubmitBtn) {
							forgotSubmitBtn.disabled = false;
							forgotSubmitBtn.textContent = 'Send Reset Link';
						}
					}
				});
			}
		});
	</script>
</body>
</html>
